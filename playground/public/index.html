<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Try Drupal</title>
    <link href="styles.css" rel="stylesheet">
</head>

<body>
    <main>
        <button id="launch" onclick="initializeCodebase();" disabled>Loading...</button>
        <button id="cleanup" onclick="cleanupCodebase();" hidden disabled>Reset</button>
    </main>
    <script type="module">
        import { sendMessageFor, onMessage } from './msg-bus.mjs';
        import { PhpWeb } from './PhpWeb.mjs';
        const sharedLibs = [`php${PhpWeb.phpVersion}-zip.so`, `php${PhpWeb.phpVersion}-zlib.so`];
        const sendMessage = sendMessageFor((`${window.location.origin}/worker.mjs`))

        const serviceWorker = navigator.serviceWorker;
        serviceWorker.register(`/worker.mjs`, {
            type: "module"
        });
        serviceWorker.addEventListener('message', event => {
            console.log(event)
        });
        serviceWorker.addEventListener('message', onMessage);

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Checking for existing install...')

            const checkWww = await sendMessage('analyzePath', ['/persist/drupal'])
            if (checkWww.exists) {
                document.getElementById('cleanup').hidden = false
                document.getElementById('cleanup').disabled = false

                document.getElementById('launch').innerHTML = 'Launch'
            } else {
                document.getElementById('launch').innerHTML = 'Install'
            }
            document.getElementById('launch').disabled = false
        });

        async function cleanup() {
            document.getElementById('launch').hidden = true;
            document.getElementById('cleanup').disabled = true;

            document.getElementById('cleanup').innerHTML = 'Cleaning up...'
            const openDb = indexedDB.open("/persist", 21);
            openDb.onsuccess = event => {
                const db = openDb.result;
                const transaction = db.transaction(["FILE_DATA"], "readwrite");
                const objectStore = transaction.objectStore("FILE_DATA");
                const objectStoreRequest = objectStore.clear();

                objectStoreRequest.onsuccess = (event) => {
                    db.close();
                    console.log('Reloading after purging data...');
                    document.getElementById('cleanup').innerHTML = 'Reloading...'
                    window.location.reload();
                };
            };
        }

        async function launchDrupal() {
            document.getElementById('launch').disabled = true;

            await navigator.serviceWorker.getRegistration(`/worker.mjs`);

            const checkWww = await sendMessage('analyzePath', ['/persist/drupal'])
            if (checkWww.exists) {
                document.getElementById('launch').innerHTML = 'Redirecting...'
                window.location = '/cgi/drupal'
                return;
            }

            document.getElementById('launch').innerHTML = 'Installing...'

            const php = new PhpWeb({ sharedLibs, persist: [{ mountPath: '/persist' }, { mountPath: '/config' }] });
            await php.binary;
            php.addEventListener('output', event => console.log(event.detail));
            php.addEventListener('error', event => console.log(event.detail));

            const checkArchive = await sendMessage('analyzePath', ['/persist/drupal.zip']);
            if (!checkArchive.exists) {
                const downloader = fetch('assets/drupal-wasm-1.0.zip');
                const download = await downloader;
                const zipContents = await download.arrayBuffer();

                document.getElementById('launch').innerHTML = 'Unpacking files...'
                console.log('Unpacking files...')
                await sendMessage('writeFile', ['/persist/drupal.zip', new Uint8Array(zipContents)]);

                const initPhpCode = await (await fetch('/assets/init.php')).text();
                console.log(await php.run(initPhpCode));

                document.getElementById('launch').innerHTML = 'Refreshing PHP...'
                console.log('Refreshing PHP...')
                await sendMessage('refresh', []);

                document.getElementById('launch').innerHTML = 'Removing archive...'
                console.log('Removing archive...');
                sendMessage('unlink', ['/persist/drupal.zip'])

                document.getElementById('launch').innerHTML = 'Redirecting...'
                console.log('Redirecting...');
                window.location = '/cgi/drupal'
            }
        }

        window.initializeCodebase = launchDrupal
        window.cleanupCodebase = cleanup
    </script>
</body>

</html>
