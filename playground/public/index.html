<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Try Drupal</title>
    <link href="styles.css" rel="stylesheet">
</head>

<body class="bg-drupal-blue">
    <main class="flex flex-col items-center mx-8 md:mx-auto gap-1 rounded-md my-4 md:max-w-screen-sm">
        <div class="rounded-md bg-yellow-50 p-4 mb-6 w-full">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Browser compatibility warnings</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <ul role="list" class="list-disc space-y-1 pl-5">
                            <li><strong>Safari</strong>: Errors on Safari with php-cgi-worker and WASM <a
                                    class="underline" href="https://github.com/mglaman/wasm-drupal/issues/28">#28</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid md:grid-cols-2 gap-6">
            <div class="divide-y divide-gray-200 overflow-hidden rounded-lg bg-drupal-white shadow flex flex-col">
                <div class="px-4 py-5 sm:p-6 flex-grow flex items-center justify-center">
                    <svg version="1.1" id="Group_38" xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" class="w-44"
                        viewBox="0 0 313.7 291.7" style="enable-background:new 0 0 313.7 291.7;" xml:space="preserve">
                        <style type="text/css">
                            .st0 {
                                fill: #009CDE;
                            }
                        </style>
                        <g>
                            <path class="st0" d="M64.2,230.9c0,19.9-16.1,36.1-36.1,36.2H0v-72.2h28.1C48.1,194.9,64.2,211,64.2,230.9 M12.3,207.1v47.7h15.9
            c13.2,0,23.8-10.8,23.8-23.9c0-13.1-10.6-23.7-23.7-23.8L12.3,207.1L12.3,207.1z M102,213.6v12.3h-7.5c-4.5,0-9.5,2.8-9.5,8.2v33
            H72.7v-53.5H85v5.5c2.4-3.4,5.5-5.5,9.5-5.5L102,213.6z M161.8,267.1h-12.3v-5.4c-4,4.8-10.7,6.6-15.7,6.6
            c-13.4,0-23.2-9.3-23.2-21.6V215H123v28c0,11,6.1,14.4,12.5,14.4c8.2,0,14.1-6.3,14.1-15.8V215h12.3V267.1z M229.4,241
            c0,15-12.1,27.3-26.7,27.3c-6.1,0-12-2.1-16.7-6v29.3h-12.3v-76.8H186v4.7c4.7-3.9,10.6-6,16.7-6
            C217.4,213.6,229.4,225.9,229.4,241 M217.2,241c0-8.5-6.5-15.1-14.4-15.1c-8,0-14.5,6.7-14.5,15.1c0,8.2,6.5,15,14.5,15
            C210.7,256.1,217.2,249.3,217.2,241 M278.5,214.9h12.3v52.3h-12.3v-4.7c-4.7,3.9-10.6,6-16.7,6c-14.6,0-26.7-12.3-26.7-27.4
            c0-15,12.1-27.3,26.7-27.3c6.1,0,12,2.1,16.7,6V214.9z M276.3,240.9c0-8.2-6.5-15-14.5-15c-7.9,0-14.4,6.8-14.4,15
            c0,8.5,6.5,15.2,14.4,15.2C269.8,256.1,276.3,249.4,276.3,240.9z M301.5,190.4h12.3v76.7h-12.3V190.4z" />
                            <path class="st0" d="M212,66.3c-0.1-0.2-0.2-0.3-0.4-0.5c-9.8-11-23.7-26.6-33.7-37.7c-3.1-3.3-6.2-6.6-9.1-10
            c-0.7-0.8-1.3-1.6-2-2.4c-0.6-0.6-0.9-1-0.9-1l0.1,0c-3.4-4-6.1-8.5-8-13.3l-0.5-1.1c0-0.1-0.1-0.1-0.2-0.2
            c-0.1-0.1-0.3-0.1-0.4-0.1h-0.1c-0.2,0-0.3,0.1-0.4,0.1c-0.1,0.1-0.1,0.1-0.2,0.2l-0.5,1.1c-2,4.8-4.7,9.3-8,13.3l0.1,0
            c0,0-0.3,0.4-0.9,1c-0.7,0.8-1.3,1.6-2,2.4c-3,3.4-6,6.7-9.1,10c-9.9,11.1-23.9,26.7-33.7,37.7c-0.1,0.2-0.2,0.3-0.4,0.5
            c-37,49.3,3.2,89.5,3.2,89.5l-0.1,0c11.9,13.8,28.8,22.3,46.9,23.6c1.6,0.2,3.3,0.3,5.1,0.3h0.1c1.7,0,3.4-0.1,5.1-0.3
            c18.2-1.3,35-9.8,46.9-23.6l-0.1,0C208.8,155.8,249,115.6,212,66.3z M125.9,101l-0.9,1.4l-0.1,0.1c-6.8,8.2-10.8,17-12.1,25.7
            c-0.2,1.1-1.2,1.8-2.2,1.6c-0.7-0.1-1.2-0.6-1.5-1.2c-1.8-4.2-3-8.6-3.6-13.1c-2.2-15.9,2.6-29.8,12.8-41.7
            c4.1-4.7,8.2-9.4,12.3-14.1c0.7-0.8,1.9-0.9,2.7-0.2c0,0,0,0,0,0c0.1,0.1,0.1,0.1,0.2,0.2c3.3,3.8,7.6,8.7,12.4,14.3
            c0.6,0.7,0.6,1.8,0,2.6c-6.6,7.9-13.6,16.3-19.9,24.3L125.9,101z M182.7,142.2L182.7,142.2c-3.8,10-11.3,16-21.9,17.7
            c-15.1,2.3-29.2-8-31.5-23.1c0-0.2,0-0.3-0.1-0.5c-1.2-8.5,1.4-16,6.9-22.4c6.4-7.5,20.5-24.9,20.7-25.2h0
            c0.3,0.3,15.3,19,20.9,25.6C184.9,122.6,186.5,132.1,182.7,142.2z M205.1,126.5L205.1,126.5c-0.1,0.3-0.3,0.7-0.4,1
            c-0.4,1-1.5,1.5-2.5,1.1c-0.6-0.3-1.1-0.8-1.2-1.5c-1.4-8.4-5.4-16.8-11.9-24.7l-0.1-0.1l-0.6-0.9l-0.4-0.5
            c-5.2-6.6-32.7-38.8-44.7-52.8c-0.6-0.7-0.6-1.8,0-2.6c4-4.4,8-8.8,11.9-13.3c0.7-0.8,1.9-0.8,2.7-0.1c0,0,0.1,0.1,0.1,0.1
            c1.8,1.9,3.5,3.8,5.2,5.8c10.9,12.2,21.9,24.2,32.5,36.5C209,89.9,212.1,107.7,205.1,126.5z" />
                        </g>
                    </svg>

                </div>
                <div class="px-4 py-4 sm:px-6">
                    <button type="button"
                        class="rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                        data-launch data-flavor="drupal" data-artifact="drupal-wasm-1.0.zip"
                        disabled>Loading...</button>
                    <button type="button"
                        class="rounded-md bg-red-500 px-3.5 py-2.5 text-sm font-semibold text-drupal-black shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-red-400"
                        data-cleanup data-flavor="drupal" hidden disabled>Reset</button>
                </div>
            </div>
            <div class="divide-y divide-gray-200 overflow-hidden rounded-lg bg-drupal-white shadow flex flex-col">
                <div class="px-4 py-5 sm:p-6 flex-grow flex items-center">
                    <img src="assets/starshot-logo.png" alt="Drupal Starshot" class="w-52 lg:w-full" />
                </div>
                <div class="px-4 py-4 sm:px-6">
                    <button type="button"
                        class="rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 cursor-not-allowed"
                        id="launch_starshot" data-flavor="starshot" disabled>Coming soon...</button>
                    <!--<button type="button"
                        class="rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                        data-launch data-flavor="starshot" data-artifact="drupal-starshot.zip"
                        disabled>Loading...</button>-->
                    <!--<button type="button"
                        class="rounded-md bg-red-500 px-3.5 py-2.5 text-sm font-semibold text-drupal-black shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-red-400"
                        data-cleanup data-flavor="starshot" hidden disabled>Reset</button>-->
                </div>
            </div>
        </div>
        <div class="mt-6">
            <a href="https://github.com/mglaman/wasm-drupal"
                class="mr-2 block text-drupal-navy hover:text-drupal-black"><span class="sr-only">GitHub</span><svg
                    viewBox="0 0 16 16" class="w-6 h-6" fill="currentColor" aria-hidden="true">
                    <path
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                    </path>
                </svg></a>
        </div>
    </main>
    <script type="module">
        import { sendMessageFor, onMessage } from './msg-bus.mjs';
        import { PhpWeb } from './PhpWeb.mjs';
        const sharedLibs = [`php${PhpWeb.phpVersion}-zip.so`, `php${PhpWeb.phpVersion}-zlib.so`];
        const sendMessage = sendMessageFor((`${window.location.origin}/worker.mjs`))
        const flavors = ['drupal', 'starshot']

        const serviceWorker = navigator.serviceWorker;

        serviceWorker.register(`/worker.mjs`, {
            type: "module"
        })
            .catch(error => {
                console.log('Browser did not support ES modules in service worker, trying bundled service worker...')
                serviceWorker.register(`/worker.js`)
                    .catch(error => {
                        alert("There was an error loading the service worker. Check known compatibility issues and your browser's developer console.")
                        console.error(error)
                    });
            });
        serviceWorker.addEventListener('message', event => {
            console.log(event)
        });
        serviceWorker.addEventListener('message', onMessage);

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Waiting for service worker...')
            await navigator.serviceWorker.ready;

            console.log('Checking for existing installs...')
            flavors.forEach(flavor => {
                console.log(`Checking ${flavor}`)
                sendMessage('analyzePath', [`/persist/${flavor}`])
                    .then(checkWww => {
                        const flavorCleanup = document.querySelector(`[data-cleanup][data-flavor="${flavor}"]`)
                        const flavorLaunch = document.querySelector(`[data-launch][data-flavor="${flavor}"]`)
                        // todo remove null check once starshot flavor launched.
                        if (flavorCleanup === null || flavorLaunch === null) {
                            return;
                        }

                        if (checkWww.exists) {
                            flavorCleanup.hidden = false
                            flavorCleanup.disabled = false

                            flavorLaunch.innerHTML = 'Launch'
                        } else {
                            flavorLaunch.innerHTML = 'Install'
                        }
                        flavorLaunch.disabled = false
                    })
            })

            document.querySelectorAll('[data-launch]').forEach(el => {
                el.addEventListener('click', launch)
            })
            document.querySelectorAll('[data-cleanup]').forEach(el => {
                el.addEventListener('click', cleanup)
            })
        });

        async function cleanup() {
            const flavor = event.target.dataset.flavor;

            const flavorCleanup = document.querySelector(`[data-cleanup][data-flavor="${flavor}"]`)
            const flavorLaunch = document.querySelector(`[data-launch][data-flavor="${flavor}"]`)

            flavorCleanup.hidden = true;
            flavorCleanup.disabled = true;

            flavorCleanup.innerHTML = 'Cleaning up...'
            const openDb = indexedDB.open("/persist", 21);
            openDb.onsuccess = event => {
                const db = openDb.result;
                const transaction = db.transaction(["FILE_DATA"], "readwrite");
                const objectStore = transaction.objectStore("FILE_DATA");
                // IDBKeyRange.bound trick found at https://stackoverflow.com/a/76714057/1949744
                const objectStoreRequest = objectStore.delete(IDBKeyRange.bound(`/persist/${flavor}`, `/persist/${flavor}/\uffff`));

                objectStoreRequest.onsuccess = async (event) => {
                    db.close();
                    console.log('Reloading after purging data...');
                    await sendMessage('refresh', []);
                    console.log('Reloading after purging data...');
                    flavorCleanup.innerHTML = 'Reloading...'
                    window.location.reload();
                };
            };
        }

        async function launch(event) {
            const { flavor, artifact } = event.target.dataset;

            const flavorCleanup = document.querySelector(`[data-cleanup][data-flavor="${flavor}"]`)
            const flavorLaunch = document.querySelector(`[data-launch][data-flavor="${flavor}"]`)

            flavorLaunch.disabled = true;

            await navigator.serviceWorker.getRegistration(`/worker.mjs`);

            const checkWww = await sendMessage('analyzePath', [`/persist/${flavor}`])
            if (checkWww.exists) {
                flavorLaunch.innerHTML = 'Redirecting...'
                window.location = `/cgi/${flavor}`
                return;
            }

            flavorLaunch.innerHTML = 'Installing...'

            const php = new PhpWeb({ sharedLibs, persist: [{ mountPath: '/persist' }, { mountPath: '/config' }] });
            await php.binary;
            php.addEventListener('output', event => console.log(event.detail));
            php.addEventListener('error', event => console.log(event.detail));

            const checkArchive = await sendMessage('analyzePath', ['/persist/artifact.zip']);
            if (checkArchive.exists) {
                flavorLaunch.innerHTML = 'Removing existing archive...'
                console.log('Removing archive...');
                await sendMessage('unlink', ['/persist/artifact.zip'])
            }

            const downloader = fetch(`/assets/${artifact}`);
            const download = await downloader;
            const zipContents = await download.arrayBuffer();

            flavorLaunch.innerHTML = 'Unpacking files...'
            console.log('Unpacking files...')
            await sendMessage('writeFile', ['/persist/artifact.zip', new Uint8Array(zipContents)]);

            await sendMessage('writeFile', ['/config/flavor.txt', flavor]);

            const initPhpCode = await (await fetch('/assets/init.php')).text();
            console.log(await php.run(initPhpCode));

            flavorLaunch.innerHTML = 'Refreshing PHP...'
            console.log('Refreshing PHP...')
            await sendMessage('refresh', []);

            flavorLaunch.innerHTML = 'Removing archive...'
            console.log('Removing archive...');
            sendMessage('unlink', ['/persist/artifact.zip'])

            flavorLaunch.innerHTML = 'Redirecting...'
            console.log('Redirecting...');
            window.location = `/cgi/${flavor}`
        }
    </script>
</body>

</html>
